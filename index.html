<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—á–µ—Ä–µ–¥—å —Å–¥–∞—á–∏ - –û–±—â–∞—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:disabled {
            background: #cccccc;
        }
        .admin-btn {
            background: #ff4444;
        }
        .queue-list {
            margin-top: 20px;
        }
        .queue-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f8f8;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .current-user {
            background: #e1f5fe;
            border-left: 4px solid #2196F3;
        }
        .number {
            font-weight: bold;
            color: #4CAF50;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        .admin-panel {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
            display: none;
        }
        .share-link {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .status-joined {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .offline-mode {
            background: #fff3e0;
            color: #ef6c00;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <h1>–û—á–µ—Ä–µ–¥—å —Å–¥–∞—á–∏ üéØ</h1>
        
        <div id="connectionStatus" class="offline-mode">
            üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        
        <div id="status"></div>
        <button id="joinBtn" disabled>–Ø —Å–¥–∞—é! (+)</button>
        
        <div class="queue-list">
            <h3>–û—á–µ—Ä–µ–¥—å:</h3>
            <div id="queueContainer">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <button id="adminBtn" class="admin-btn" disabled>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
        
        <div class="admin-panel" id="adminPanel">
            <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
            <p>–¢–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å</p>
            <button id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</button>
            <button id="leaveBtn">–£–±—Ä–∞—Ç—å –º–µ–Ω—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏</button>
            
            <div style="margin-top: 15px;">
                <h4>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π:</h4>
                <div class="share-link" id="shareLink">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
                <button id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            </div>
        </div>
    </div>

    <script>
        // === –í–ê–®–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyC9rdaCpZ79t79rJYmnDXUlfVhr72m3mcA",
            authDomain: "queu-2f3.firebaseapp.com",
            databaseURL: "https://queu-2f3-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "queu-2f3",
            storageBucket: "queu-2f3.firebasestorage.app",
            messagingSenderId: "71623354102",
            appId: "1:71623354102:web:b47d5e27408d5b4e3e6ed7"
        };

        // App settings
        const ADMIN_PASSWORD = "090703";
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        let isConnected = false;
        
        let queue = [];
        let userId = localStorage.getItem('userId');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('userId', userId);
        }

        // DOM elements
        const joinBtn = document.getElementById('joinBtn');
        const adminBtn = document.getElementById('adminBtn');
        const adminPanel = document.getElementById('adminPanel');
        const resetBtn = document.getElementById('resetBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const copyBtn = document.getElementById('copyBtn');
        const statusDiv = document.getElementById('status');
        const queueContainer = document.getElementById('queueContainer');
        const shareLink = document.getElementById('shareLink');
        const connectionStatus = document.getElementById('connectionStatus');

        // Initialize Firebase with error handling
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                const database = firebase.database();
                
                // Test connection
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        isConnected = true;
                        connectionStatus.innerHTML = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö";
                        connectionStatus.className = "status status-joined";
                        joinBtn.disabled = false;
                        adminBtn.disabled = false;
                        setupDatabaseListeners(database);
                    } else {
                        isConnected = false;
                        connectionStatus.innerHTML = "‚ö†Ô∏è –û—Ñ—Ñ–ª–∞–π–Ω - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç";
                        connectionStatus.className = "offline-mode";
                        joinBtn.disabled = true;
                        adminBtn.disabled = true;
                    }
                });

                return database;
            } catch (error) {
                console.error("Firebase initialization error:", error);
                connectionStatus.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase";
                connectionStatus.className = "error-message";
                return null;
            }
        }

        function setupDatabaseListeners(database) {
            // Listen for queue changes
            database.ref('queue').on('value', (snapshot) => {
                const data = snapshot.val();
                console.log("Data received:", data);
                
                if (data) {
                    queue = Object.keys(data).map(key => {
                        return { firebaseKey: key, ...data[key] };
                    });
                    queue.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                } else {
                    queue = [];
                }
                updateDisplay();
            }, (error) => {
                console.error("Database error:", error);
                connectionStatus.innerHTML = "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö";
                connectionStatus.className = "error-message";
            });
        }

        // Initialize the app
        const database = initializeFirebase();

        // Event listeners
        joinBtn.addEventListener('click', joinQueue);
        adminBtn.addEventListener('click', toggleAdmin);
        resetBtn.addEventListener('click', resetQueue);
        leaveBtn.addEventListener('click', clearMyQueue);
        copyBtn.addEventListener('click', copyShareLink);

        function updateDisplay() {
            queueContainer.innerHTML = '';
            if (queue.length === 0) {
                queueContainer.innerHTML = '<p>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</p>';
            } else {
                queue.forEach((person, index) => {
                    const div = document.createElement('div');
                    div.className = 'queue-item';
                    if (person.userId === userId) {
                        div.classList.add('current-user');
                    }
                    div.innerHTML = `
                        <span class="number">${index + 1}.</span>
                        <span>${person.name}</span>
                        <span class="timestamp">${new Date(person.timestamp).toLocaleTimeString()}</span>
                    `;
                    queueContainer.appendChild(div);
                });
            }
            
            const userInQueue = queue.some(person => person.userId === userId);
            
            if (userInQueue) {
                joinBtn.disabled = true;
                const userPosition = queue.findIndex(p => p.userId === userId) + 1;
                joinBtn.textContent = '–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏!';
                statusDiv.innerHTML = `<div class="status status-joined">–í–∞—à –Ω–æ–º–µ—Ä –≤ –æ—á–µ—Ä–µ–¥–∏: ${userPosition}</div>`;
            } else {
                joinBtn.disabled = !isConnected;
                joinBtn.textContent = '–Ø —Å–¥–∞—é! (+)';
                statusDiv.innerHTML = '';
            }

            updateShareLink();
        }

        function getUserName() {
            let name = localStorage.getItem('userName');
            if (!name) {
                name = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:');
                if (name) {
                    localStorage.setItem('userName', name);
                } else {
                    name = '–ê–Ω–æ–Ω–∏–º';
                }
            }
            return name;
        }

        function joinQueue() {
            if (!isConnected) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!');
                return;
            }
            
            const name = getUserName();
            const timestamp = new Date().toISOString();
            
            if (!queue.some(person => person.userId === userId)) {
                database.ref('queue').push({
                    userId: userId,
                    name: name,
                    timestamp: timestamp
                }).catch((error) => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –æ—á–µ—Ä–µ–¥—å: ' + error.message);
                });
            }
        }

        function toggleAdmin() {
            if (!isConnected) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!');
                return;
            }
            
            if (isAdmin) {
                adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
            } else {
                const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:');
                if (password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    localStorage.setItem('isAdmin', 'true');
                    adminPanel.style.display = 'block';
                    alert('–ê–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø –≤–∫–ª—é—á–µ–Ω!');
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                }
            }
        }

        function resetQueue() {
            if (!isConnected) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!');
                return;
            }
            
            if (!isAdmin) {
                alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å!');
                return;
            }
            
            if (confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≤—Å–µ—Ö?')) {
                database.ref('queue').remove()
                    .then(() => alert('–û—á–µ—Ä–µ–¥—å —Å–±—Ä–æ—à–µ–Ω–∞!'))
                    .catch((error) => alert('–û—à–∏–±–∫–∞: ' + error.message));
            }
        }

        function clearMyQueue() {
            if (!isConnected) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!');
                return;
            }
            
            const userEntry = queue.find(person => person.userId === userId);
            if (userEntry) {
                database.ref('queue/' + userEntry.firebaseKey).remove()
                    .then(() => alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏!'))
                    .catch((error) => alert('–û—à–∏–±–∫–∞: ' + error.message));
            } else {
                alert('–í—ã –Ω–µ –≤ –æ—á–µ—Ä–µ–¥–∏!');
            }
        }

        function updateShareLink() {
            shareLink.textContent = window.location.href;
        }

        function copyShareLink() {
            navigator.clipboard.writeText(shareLink.textContent)
                .then(() => alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'))
                .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'));
        }

        // Initial setup
        updateShareLink();
        
        if (!localStorage.getItem('firstVisit')) {
            setTimeout(() => {
               alert('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üìö\n\n–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n1. –ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã –≤—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å\n2. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –æ–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∞–º–∏\n3. –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å');
                localStorage.setItem('firstVisit', 'true');
            }, 1000);
        }
    </script>
</body>
</html>
